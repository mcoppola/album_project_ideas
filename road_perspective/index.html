<!DOCTYPE html>
<html>
<head>
  <meta charset = "utf-8">
    <title>room 1</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>

    <canvas id='canvas' width="600" height="600">
    </canvas>

    <script src="utils.js"></script>
    <script src="road.js"></script>
    <script>
      window.onload = function () {
        var limitLoop = function (fn, fps) {
          // Use var then = Date.now(); if you
          // don't care about targetting < IE9
          var then = new Date().getTime();
           
          // custom fps, otherwise fallback to 60
          fps = fps || 60;
          var interval = 1000 / fps;
          return (function loop(time){
          requestAnimationFrame(loop);
          // again, Date.now() if it's available
          var now = new Date().getTime();
          var delta = now - then;
          if (delta > interval) {
            // Update time
            // now - (delta % interval) is an improvement over just
            // using then = now, which can end up lowering overall fps
            then = now - (delta % interval);
            // call the fn
            fn();
          }
          }(0));
        };

        var canvas = document.getElementById('canvas'),
        lastCalledTime,
        fps,
        context = canvas.getContext('2d'),
        delay = 100;
        room = new Room(context, canvas.width, canvas.height);
        frame = 0;
        snowFlakes = [];

        context.font = "bold 12px sans-serif";
        context.fillText("play", canvas.width/2, canvas.height/2);
        
        mouse = utils.captureMouse(canvas);

        //play+pause controls and snoflakes while running
        canvas.addEventListener('mousedown', function() {
            if (room.playing) {
              if (Math.abs(mouse.x - canvas.width/2) < 10 && Math.abs(mouse.y - canvas.height) < 14) {
                room.playing = false;
                room.paused = true;
                context.clearRect(mouse.x - 10, mouse.y - 10, 20, 20);
                context.font = "bold 12px sans-serif";
                context.fillText(">", canvas.width/2, canvas.height - 4);
              } 
              else {  
                snowFlakes.push(new SnowFlake(mouse.x, mouse.y, canvas.width, canvas.height));
                //room.oldColorChange = room.colorchange;
                //room.colorChange = s.color;

              }
            }
            else if (room.paused) {
              if (Math.abs(mouse.x - canvas.width/2) < 10 && Math.abs(mouse.y - canvas.height) < 10) {
                room.playing = true;
                room.paused = false;
              }
            }
            else {
              if (Math.abs(mouse.x - canvas.width/2) < 40 && Math.abs(mouse.y - canvas.height/2) < 20) {
                room.playing = true;
              }
          }
        }, false);


        touch = utils.captureTouch(canvas);
        if (touch.isPressed) {
          if (room.playing) {
          snowFlakes.push(new SnowFlake(touch.x, touch.y, canvas.width, canvas.height))
          }
          else {
            if (Math.abs(mouse.x - canvas.width/2) < 8 && Math.abs(mouse.y - canvas.height/2) < 20) {
              room.playing = true;
            }
          }
        }
      

      (function drawFrame () {
        utils.getAnimationFrame();
        window.requestAnimationFrame(drawFrame, canvas);

//FPS
/*        if(!lastCalledTime) {
             lastCalledTime = new Date().getTime();
             fps = 0;
             return;
        }
        delta = (new Date().getTime() - lastCalledTime)/1000;
        lastCalledTime = new Date().getTime();
        fps = 1/delta;
        if(room.frame%20 == 0) {
          document.getElementById('fps').innerHTML = 'fps: ' + fps;
        }*/

        if(room.playing) {
          context.clearRect(0, 0, canvas.width, canvas.height);

          context.font = "bold 12px sans-serif";
          context.fillText("II", canvas.width/2, canvas.height - 4);

          room.frame += 1;
          room.x += 1;
          room.y += 1;
        

        room.play();
        /*if(frame%20 == 0) {
            snowFlakes.push(new SnowFlake(Math.random()*canvas.width, Math.random()*canvas.height, canvas.width, canvas.height));
        }*/

        for (var i = 0; i < snowFlakes.length; i++) {
                   
          snowFlakes[i].z -= 0.005;
          snowFlakes[i].draw(context, room.frame, canvas.width, canvas.height);

          if(snowFlakes[i].z < 0) {
            snowFlakes.splice(i, 1);
          }
        }
          


        }
      


      }());

    limitLoop(drawFrame, 3);
    };
    </script>
    <p id='fps'>n</p>
  </body>
  </html>